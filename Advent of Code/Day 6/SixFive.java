import java.util.HashSet;
import java.util.Map;
import java.util.Set;


public class SixFive {
    static Map<Integer, int[]> directions = Map.of(
        0, new int[]{-1, 0}, // Up
        1, new int[]{0, 1}, // Right
        2, new int[]{1, 0}, // Down
        3, new int[]{0, -1} // Left
    );

    static char[][] input;

    // static final String inputString = """
    //     ....#.....
    //     .........#
    //     ..........
    //     ..#.......
    //     .......#..
    //     ..........
    //     .#..^.....
    //     ........#.
    //     #.........
    //     ......#...
    //     """;

    static final String inputString = """
        #.....#.........#.........................#...#....................#......#.......#...........#........#..........................
        ..................#......#..................................#..................#....#...............#.#....................#.....#
        ..............#...........#......#.#.......................................#..................#......#............................
        ##...............................#..........#...................#.......#................................................#........
        #.....................#.......##................#...#..........#............................................#...#....#............
        ........#........#.............#...............#...##...................#...........#...........#.......#...........##.#...#.#....
        ................................................#....................................................#.#..........................
        .........#....#.....................................................................##......#.....#........#...............#......
        .............................#.....#.........#......................#...#................#.#..........#...........................
        ........................................#.........................................................................#...............
        .........................................#.......#.............#.#.........................#....#.....#...........#...............
        ...#............##...................................#...........#........................................#..................#....
        ....#.................#.......#............#.....#...........#................................#.#.#...........................#...
        ...#................................................................#.......................#.#........................#..#...#...
        ............................#......#.......#...............................................................................#....#.
        .......................................................#.............................#...#.......#.............#............#.....
        .....................................................................#......................................#.................##..
        ......#.................#......................................................#................#.................................
        ...............................................................................#...............#............................#.....
        ........................................................#......................##..................#........#.....................
        .#.................................#....#........#..#........#.................................#...............#..........#.#.....
        .................#................#...................#.#.....#................#..................#.........#.....................
        ...............#........................................................................#............#..........#.................
        ....................#..................#...........#................................#.....................#...#......#............
        .............#..#..................................#..............................#...............................#...#......#...#
        ..................#.............................................................#...............................#......#..........
        ................................................................#....#..............#.............................#...............
        .............#............#............................#...#........#...#.........................##..............................
        ....................................#....#.............#...#....#..........................#..................#.#............#....
        .......................#........................................................................................#.................
        ........#..................................#..#.........#.......................................#......#..............#...........
        ..........#............#............#..................#.......#..........#...................................#...........#.......
        ....#..............................#.....#...........##...#.....................#...........................#..........#..........
        ................................#..#.................................................................#...#...................#....
        ..#....................#..........................................................................#...............................
        ..................#........................#.......#..#......................................................................#....
        .#.....#......................#.....................................#.........................................#...................
        ..#....#...........................................#..........................................................................#...
        ..#.....#........................................................................#........#.#.............................#.......
        ................#......................................#...............#....................................#..........#..........
        ....................................#........................##.............................#..........................#........#.
        .#..............#..............................#......................................................#...........................
        ...#.#......................#.................#..................................#...........................#....................
        ..#....#..........................................#...#.......#..............................................#....................
        .......#.................#............................#..................................................#..#....................#
        .....##.#...........#...........................................#.....................................................#...........
        ................#.#........................................................................#..........#..#....#.##................
        ..........#........#............................................#.#......................................#.............#..........
        ............................................................#..........................................#..........................
        .......#........#.................#....................................................................#..........................
        ........................................................#..........................#..............#...............................
        .............#.#....................................#.................##............#.#.............................#..........#..
        .##.............................................^........#...................#.....#...................................#..........
        ...............#..#..#................................................................#...........................#...............
        .#.......##...........#.........#..................#......#..........#...#....#...................#...............................
        ....#................................................................#...................#........................................
        .........#............#..#......................................................#..#..............................................
        ...#.............................................................#......#....#....................................#...#....#......
        .....#.........#.................#....................#..................#..#.#.............#......#.....................#........
        ...........#.......#.##.#......#..#.............................#...........#..............................................#......
        ................................................................................................#.#......#......................#.
        ##..................................##....#.................#...............##....................................................
        .....#.............................#.............................................#................#.....................#.........
        ............#..............................#.....................#...............#..#....#....#...................................
        .........#.........................#...#................................................#........................................#
        .#..........................................#.......#.....................................................#..............#...#....
        #.........#...........#.............#..........................#........................................#.........................
        .......................................................................#.............................................#............
        ....#..............#..#......................................................#..........................................#....#....
        ........#...................................#...#................#.........................................................#...#..
        .........................................................#..#..#..#..........#...........#...........#............#...............
        ..............................................##......#.................#..............................................#..........
        .............................#..........#......#.....#....#.............#..............................................#...#..#...
        ......................................##......#.....................................#.......#....................#................
        ...................................................................................................#..............................
        .................................#..................................................................................#.............
        ........#...................................................................#...................##............#...................
        ...............................#..................................................................................................
        ...............................#...........................................................#...............##..............#......
        ........................................................................#..........#..................................#...........
        ................#.................................................................................................................
        ...#.................#..........#...........#...................................#......................#..........................
        .......................#..........................................................#.............#.............#..........#........
        ..........#..........#.#.................................#........#.............#..#..........................#........#.........#
        .................#.........#.#........................#...#.............................................................#......#..
        ......#.....................................................................#.....#...............#...............#....#..........
        ......#...##....#..#.......................................##......#......#....#..............#............#....................#.
        .#..........#........#...#........##..............#....#...........................#.....#................#...................#...
        .........................#........................................................................................................
        ..........................#.......................#.........#................................................#.#...........#......
        ......#...#.....#..........#....................#..................................#...#.................................#........
        .......................................................#............................#.....................#.#.................#...
        ..............#...............#......................#......#...................#.....................#.........#................#
        ....#.........#...............................................................#.......#.......#...........#.................#.....
        .......................#.........................#....................................#...........................................
        ...............#.................#..........#........................#...##.......................................................
        ....##..................#..#..................................................................................#.................#.
        ..................#.............#......................#...............#................#.#.......................................
        ........................#....#................................................#...#..........#....#.......#.......................
        .........................................................#..............#.............#.#.......#..................#......#...#...
        ...........#...........................#.........#..................................#.....................................#.......
        .#..........................................#................................................................#...........#........
        ..................................##....................#..........#..............#..........#............#.....#.................
        ##..#..#....#.........................................................#...............#...................................#.......
        ....#.#...........#............................#....#........#......#.............................................................
        #....#.........................#.............#.............................................................#.....#..#.............
        ............................#......#................#...............................................#.....#............#..........
        ........................#.............#..................#........................................................................
        ..#.............#........................................#.................................................#......................
        ...................#...................#..........#..#.............................................#...........#...#............#.
        ....#...#..........................##...#...............#....#.....................................#............#.................
        ..............................#..............................................................###..................................
        .................#......................................#.......................##.#............#.................................
        ............#.........................................#......##.....................#............#................................
        ....................#..#.............................#...#......................................#....................#.#........#.
        ....#...........#...........................................#....................................................#................
        ............#.....#..................................##.........#........#.....................................#..................
        ......#..............#..................................#...#.......#.............................................................
        ..........#.................#.......#.........................................................................#...........#.......
        ...........#..............#................#.....##.#............#........#.......................................................
        ................#.......................#.........................................................................#...........#...
        ..............................#............................................#.......#..............................................
        ..............#..............................#......#..................#....#.....#.................................#........#....
        ....................##..........#...#..#................#............#.......................#.................................#..
        ........................##.......#..................#.......#.....................#................#.....................#.....#..
        ..............#.............#...#......#.........#.................##..#...........#...........#.........................##.......
        #........#...........#........#..#............#...........#....#....#......##..............................................#......
        ........................................#.....................#....................................#........#......#......#.......
        .............#........#.............#...........#..#..#.......................................................#......#............
        #...................#.#........................................#..................................#...#...........................
        """;

    private static void convertInputStringToCharArray() {
        String[] splitLines = inputString.split("\n");
        input = new char[splitLines.length][];

        for (int i = 0; i < splitLines.length; i++) {
            input[i] = splitLines[i].toCharArray();
        }
    }

    static int maxRows;
    static int maxCols;

    public static void simulateGuardPath() {
        maxRows = input.length;
        maxCols = input[0].length;
        
        // Find the starting position
        int startRow = -1;
        int startCol = -1;
        for (int row = 0; row < maxRows; row++) {
            for (int col = 0; col < maxCols; col++) {
                if (input[row][col] == '^') {
                    startRow = row;
                    startCol = col;
                    break;
                }
            }
            if (startRow != -1) break;
        }
        
        if (startRow == -1 || startCol == -1) {
            System.out.println("No guard found on the map");
            return;
        }
        
        System.out.println("Guard starting at: Row " + startRow + ", Col " + startCol);

        int numberOfInfiniteLoops = 0;

        for (int row = 0; row < maxRows; row++) {
            for (int col = 0; col < maxCols; col++) {
                if (input[row][col] == '#' || (row == startRow && col == startCol)) {
                    continue;
                } 

                // Add temporary obstacle
                input[row][col] = '#';

                // Check if loop exists with a starting direction of 0 (Guard facing up)
                if (loopExists(startRow, startCol, 0)) {
                    numberOfInfiniteLoops++;
                }

                // Remove temporary obstacle
                input[row][col] = '.';
            }
        }
        
        // Print numberOfInfiniteLoops
        System.out.println("Total infinite loop positions available: " + numberOfInfiniteLoops);
    }

    public static boolean loopExists(int startRow, int startCol, int startDirection) {

        Set<Triple> visited = new HashSet<>();


        int row = startRow;
        int col = startCol;
        int direction = startDirection;
        
        // maxSteps to prevent an infinite loop. 
        // Calculation allows for each position in each direction
        int maxSteps = 4 * maxRows * maxCols;

        // Main simulation loop
        for (int step = 0; step <= maxSteps; step++) {
            // Calculate next position
            int[] dirs = directions.get(direction);
            int newRow = row + dirs[0];
            int newCol = col + dirs[1];
            Triple currentCoordinates = new Triple(row, col, direction);

             // Check if we're leaving the map
            if (newRow < 0 || newRow >= maxRows || newCol < 0 || newCol >= maxCols) {
                // As guard left map there is not an infinite loop present
                return false;
            }

            // Coordinate has already been visited (in the same direction), therefore guard stuck in infinite loop
            if (visited.contains(currentCoordinates)) {
                return true;
            }

            // Check if there's an obstacle
            if (input[newRow][newCol] == '#') {
                // Turn right
                direction = (direction + 1) % 4;
            } else {
                // Move forward
                row = newRow;
                col = newCol;
                visited.add(currentCoordinates);
            }

        }

        // Guard not left map in appropriate time, therefore infinite loop present
        return true;
    }

    public static void main(String[] args) {
        convertInputStringToCharArray();
        simulateGuardPath();
    }
}

class Triple {
    private final int x;
    private final int y;
    private final int z;

    public Triple(int x, int y, int z) {
        this.x = x;
        this.y = y;
        this.z = z;
    }

    public int getX() { return x; }
    public int getY() { return y; }
    public int getZ() { return z; }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Triple triple = (Triple) o;
        return x == triple.x && y == triple.y && z == triple.z;
    }

    @Override
    public String toString() {
        return "(" + x + ", " + y + ", " + z + ")";
    }

    @Override
    public int hashCode() {
        return 31 * x + y + z;
    }
}

class Point {
    private final int x;
    private final int y;

    public Point(int x, int y) {
        this.x = x;
        this.y = y;
    }

    public int getX() { return x; }
    public int getY() { return y; }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Point point = (Point) o;
        return x == point.x && y == point.y;
    }

    @Override
    public String toString() {
        return "(" + x + ", " + y + ")";
    }

    @Override
    public int hashCode() {
        return 31 * x + y;
    }
} 
